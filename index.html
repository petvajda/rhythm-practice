<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rhythm Practice">
    <meta name="theme-color" content="#0a0a0a">
    <title>Rhythm Practice Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.2/dist/abcjs-basic-min.js"></script>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlJoeXRobSBQcmFjdGljZSBHZW5lcmF0b3IiLAogICJzaG9ydF9uYW1lIjogIlJoeXRobSBQcmFjdGljZSIsCiAgImRlc2NyaXB0aW9uIjogIkdlbmVyYXRlIHJhbmRvbSByaHl0aG0gZXhlcmNpc2VzIGZvciBtdXNpYyBwcmFjdGljZSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBhMGEwYSIsCiAgInRoZW1lX2NvbG9yIjogIiMwYTBhMGEiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgNTEyIDUxMiclM0UlM0NyZWN0IGZpbGw9JyUyMzBhMGEwYScgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInLyUzRSUzQ3BhdGggZmlsbD0nJTIzZmYzMzY2JyBkPSdNMjU2IDEyOGM3MC43IDAgMTI4IDU3LjMgMTI4IDEyOHMtNTcuMyAxMjgtMTI4IDEyOC0xMjgtNTcuMy0xMjgtMTI4IDU3LjMtMTI4IDEyOC0xMjhtMC00OGMtOTcuMiAwLTE3NiA3OC44LTE3NiAxNzZzNzguOCAxNzYgMTc2IDE3NiAxNzYtNzguOCAxNzYtMTc2UzM1My4yIDgwIDI1NiA4MHonLyUzRSUzQ2NpcmNsZSBmaWxsPSclMjNmZjMzNjYnIGN4PScyNTYnIGN5PScyNTYnIHI9JzI0Jy8lM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0sCiAgImNhdGVnb3JpZXMiOiBbIm11c2ljIiwgImVkdWNhdGlvbiJdCn0=">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%230a0a0a' width='512' height='512'/><path fill='%23ff3366' d='M256 128c70.7 0 128 57.3 128 128s-57.3 128-128 128-128-57.3-128-128 57.3-128 128-128m0-48c-97.2 0-176 78.8-176 176s78.8 176 176 176 176-78.8 176-176S353.2 80 256 80z'/><circle fill='%23ff3366' cx='256' cy='256' r='24'/></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --accent-primary: #ff3366;
            --accent-secondary: #00d9ff;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-tertiary: #606060;
            --border: #2a2a2a;
            --success: #00ff88;
            --playing: #ffd700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            width: 100%;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
        
        html {
            height: -webkit-fill-available;
            background: var(--bg-primary);
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 51, 102, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 217, 255, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 100%;
            width: 100%;
            min-height: 100vh;
            padding: 0;
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            background: rgba(26, 26, 26, 0.95);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            text-align: center;
        }
        
        .header p {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
            text-align: center;
        }
        
        /* Main content area */
        .main-content {
            padding: 20px;
            background: var(--bg-primary);
        }
        
        /* Music display */
        .music-display {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px 16px;
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .music-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .music-display.playing::before {
            opacity: 1;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }
        
        #music {
            width: 100%;
        }
        
        .empty-state {
            text-align: center;
            color: var(--text-tertiary);
            padding: 40px 20px;
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        /* Control panels */
        .control-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .control-panel.compact {
            padding: 16px 20px 12px 20px;
            margin-bottom: 12px;
        }
        
        .panel-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-header::before {
            content: '';
            width: 3px;
            height: 14px;
            background: var(--accent-primary);
            border-radius: 2px;
        }
        
        /* Form elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .form-row.two-col {
            grid-template-columns: 1fr 1fr;
        }
        
        .form-row.playback-row {
            grid-template-columns: 4fr 1fr;
            gap: 0;
        }
        
        .form-row .form-group {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }
        
        select {
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23a0a0a0' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 44px;
        }
        
        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-primary);
        }
        
        /* Checkbox groups */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .checkbox-item {
            position: relative;
        }
        
        .checkbox-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .checkbox-item label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            user-select: none;
        }
        
        .checkbox-item input[type="checkbox"]:checked + label {
            background: rgba(255, 51, 102, 0.15);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .checkbox-item input[type="checkbox"]:checked + label::before {
            content: '✓';
            margin-right: 6px;
            font-weight: 800;
        }
        
        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 18px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), #ff1744);
            color: white;
            box-shadow: 0 4px 16px rgba(255, 51, 102, 0.3);
        }
        
        .btn-primary:disabled {
            background: linear-gradient(135deg, #666, #555);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-primary:disabled:active {
            transform: none;
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:active {
            background: var(--bg-primary);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #00cc77);
            color: var(--bg-primary);
            box-shadow: 0 4px 16px rgba(0, 255, 136, 0.2);
        }
        
        .btn-play {
            background: linear-gradient(135deg, var(--playing), #ffaa00);
            color: var(--bg-primary);
            box-shadow: 0 4px 16px rgba(255, 215, 0, 0.3);
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            align-self: flex-start;
        }
        
        /* Status messages */
        .status {
            margin-top: 16px;
            padding: 14px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status.success {
            background: rgba(0, 255, 136, 0.15);
            color: var(--success);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .status.playing {
            background: rgba(255, 215, 0, 0.15);
            color: var(--playing);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        /* Tempo slider */
        .tempo-control {
            margin-top: 0;
        }
        
        .tempo-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .tempo-display label {
            margin-bottom: 0;
        }
        
        .tempo-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 500;
            color: var(--accent-secondary);
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 51, 102, 0.4);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(255, 51, 102, 0.4);
        }
        
        /* Install prompt */
        .install-banner {
            background: linear-gradient(135deg, rgba(255, 51, 102, 0.1), rgba(0, 217, 255, 0.1));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin: 20px;
            display: none;
            align-items: center;
            gap: 12px;
        }
        
        .install-banner.show {
            display: flex;
        }
        
        .install-banner-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .install-banner-content {
            flex: 1;
        }
        
        .install-banner-content h3 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .install-banner-content p {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .install-banner button {
            padding: 10px 20px;
            font-size: 14px;
        }
        
        /* Loading state */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading.show {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 380px) {
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
        
        /* Dark safe areas for iOS notch */
        @supports (padding: max(0px)) {
            body {
                padding-top: max(20px, env(safe-area-inset-top));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }
        }
        
        /* Page navigation */
        .page {
            display: none;
            background: var(--bg-primary);
        }
        
        .page.active {
            display: block;
            background: var(--bg-primary);
        }
        
        /* Cursor highlighting for notes during playback */
        .abcjs-cursor {
            fill: #ff3366 !important;
        }
        
        .abcjs-cursor circle,
        .abcjs-cursor path {
            fill: #ff3366 !important;
        }
        
        /* Header alignment */
        header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-button {
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: all 0.2s;
        }
        
        .nav-button:active {
            transform: translateY(-50%) scale(0.95);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .nav-button svg {
            width: 24px;
            height: 24px;
            display: block;
            margin: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Rhythm Practice</h1>
            <p>Generate random rhythm exercises</p>
            
            <!-- Settings Button -->
            <button class="nav-button" id="navButton" onclick="togglePage()" aria-label="Settings">
                <span style="color: white; font-size: 20px; font-weight: bold; line-height: 1;">⋯</span>
            </button>
        </div>
        
        <div class="install-banner" id="installBanner">
            <div class="install-banner-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
            </div>
            <div class="install-banner-content">
                <h3>Install App</h3>
                <p>Add to home screen for quick access</p>
            </div>
            <button class="btn-primary" onclick="installApp()">Install</button>
        </div>
        
        <div class="main-content">
            <!-- Page 1: Main Practice -->
            <div id="page1" class="page active">
                <div class="control-panel compact">
                    <div class="panel-header">Exercise Setup</div>
                    
                    <div class="form-row" style="align-items: flex-end;">
                        <div class="form-group">
                            <label for="barCount">Bars</label>
                            <select id="barCount">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="4" selected>4</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="bassNote">Note</label>
                            <select id="bassNote" onchange="redrawWithNewNote()">
                                <option value="F,,">F</option>
                                <option value="G,,">G</option>
                                <option value="A,,">A</option>
                                <option value="B,,">B</option>
                                <option value="C,">C</option>
                                <option value="D,">D</option>
                                <option value="E,,">E</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button id="generateButton" class="btn-primary" onclick="generateRhythm()" style="width: 100%; margin: 0;">
                                Generate
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="music-display" id="musicDisplay">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18V5l12-2v13"/>
                            <circle cx="6" cy="18" r="3"/>
                            <circle cx="18" cy="16" r="3"/>
                        </svg>
                        <p>Generate a rhythm to begin</p>
                    </div>
                    <div id="music"></div>
                </div>
                
                <div class="control-panel compact">
                    <div class="panel-header">Playback</div>
                    
                    <div class="form-row playback-row">
                        <div class="form-group" style="display: flex; flex-direction: column; justify-content: flex-end;">
                            <div class="tempo-control">
                                <div class="tempo-display">
                                    <label style="margin: 0;">Tempo</label>
                                    <span class="tempo-value" id="tempoValue">80</span>
                                </div>
                                <input type="range" id="tempo" min="50" max="180" value="80" 
                                       oninput="document.getElementById('tempoValue').textContent = this.value">
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px;">
                                <input type="checkbox" id="countIn" checked style="width: 20px; height: 20px; cursor: pointer;">
                                <label for="countIn" style="margin: 0; cursor: pointer; user-select: none;">Count-in</label>
                            </div>
                        </div>
                        
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn-play" onclick="playRhythm()" style="width: 100%; margin: 0 0 0 16px;">
                                ▶ Play
                            </button>
                        </div>
                    </div>
                    
                    <div id="statusMessage"></div>
                </div>
            </div>
            
            <!-- Page 2: Pattern Selection -->
            <!-- Page 2: Pattern Selection -->
            <div id="page2" class="page">
                <div class="control-panel">
                    <div class="panel-header">Select Rhythm Patterns</div>
                
                <div class="form-group">
                    <label style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleGroup('simple', event)">
                        <input type="checkbox" id="group-simple" checked style="margin: 0; cursor: pointer;">
                        Simple Patterns
                    </label>
                    <div class="checkbox-group" id="group-simple-patterns">
                        <div class="checkbox-item">
                            <input type="checkbox" id="simple_whole" value="simple_whole" checked class="pattern-simple">
                            <label for="simple_whole">R4</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="simple_quarter" value="simple_quarter" checked class="pattern-simple">
                            <label for="simple_quarter">4</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="simple_sixteenths" value="simple_sixteenths" checked class="pattern-simple">
                            <label for="simple_sixteenths">16+16+16+16</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleGroup('1note', event)">
                        <input type="checkbox" id="group-1note" checked style="margin: 0; cursor: pointer;">
                        1-Note Patterns
                    </label>
                    <div class="checkbox-group" id="group-1note-patterns">
                        <div class="checkbox-item">
                            <input type="checkbox" id="1note_pattern1" value="1note_pattern1" checked class="pattern-1note">
                            <label for="1note_pattern1">R16+16+R8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="1note_pattern2" value="1note_pattern2" checked class="pattern-1note">
                            <label for="1note_pattern2">16+R8.</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="1note_pattern3" value="1note_pattern3" checked class="pattern-1note">
                            <label for="1note_pattern3">R8.+16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="1note_pattern4" value="1note_pattern4" checked class="pattern-1note">
                            <label for="1note_pattern4">R8+16+R16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="1note_pattern5" value="1note_pattern5" checked class="pattern-1note">
                            <label for="1note_pattern5">R8+8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="1note_pattern6" value="1note_pattern6" checked class="pattern-1note">
                            <label for="1note_pattern6">8+R8</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleGroup('2note', event)">
                        <input type="checkbox" id="group-2note" checked style="margin: 0; cursor: pointer;">
                        2-Note Patterns
                    </label>
                    <div class="checkbox-group" id="group-2note-patterns">
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern1" value="2note_pattern1" checked class="pattern-2note">
                            <label for="2note_pattern1">R8+16+16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern2" value="2note_pattern2" checked class="pattern-2note">
                            <label for="2note_pattern2">16+16+R8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern3" value="2note_pattern3" checked class="pattern-2note">
                            <label for="2note_pattern3">R16+16+16+R16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern4" value="2note_pattern4" checked class="pattern-2note">
                            <label for="2note_pattern4">16+8.</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern5" value="2note_pattern5" checked class="pattern-2note">
                            <label for="2note_pattern5">8.+16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern6" value="2note_pattern6" checked class="pattern-2note">
                            <label for="2note_pattern6">16+R8+16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern7" value="2note_pattern7" checked class="pattern-2note">
                            <label for="2note_pattern7">8+8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern8" value="2note_pattern8" checked class="pattern-2note">
                            <label for="2note_pattern8">R16+16+R16+16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern9" value="2note_pattern9" checked class="pattern-2note">
                            <label for="2note_pattern9">16+R16+16+R16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern10" value="2note_pattern10" checked class="pattern-2note">
                            <label for="2note_pattern10">16+8+R16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="2note_pattern11" value="2note_pattern11" checked class="pattern-2note">
                            <label for="2note_pattern11">R16+16+8</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleGroup('3note', event)">
                        <input type="checkbox" id="group-3note" checked style="margin: 0; cursor: pointer;">
                        3-Note Patterns
                    </label>
                    <div class="checkbox-group" id="group-3note-patterns">
                        <div class="checkbox-item">
                            <input type="checkbox" id="3note_pattern1" value="3note_pattern1" checked class="pattern-3note">
                            <label for="3note_pattern1">R16+16+16+16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="3note_pattern2" value="3note_pattern2" checked class="pattern-3note">
                            <label for="3note_pattern2">16+16+16+R16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="3note_pattern3" value="3note_pattern3" checked class="pattern-3note">
                            <label for="3note_pattern3">16+16+8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="3note_pattern4" value="3note_pattern4" checked class="pattern-3note">
                            <label for="3note_pattern4">8+16+16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="3note_pattern5" value="3note_pattern5" checked class="pattern-3note">
                            <label for="3note_pattern5">16+8+16</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="3note_pattern6" value="3note_pattern6" checked class="pattern-3note">
                            <label for="3note_pattern6">16+16+R16+16</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;" onclick="toggleGroup('triplet', event)">
                        <input type="checkbox" id="group-triplet" style="margin: 0; cursor: pointer;">
                        Triplet Patterns
                    </label>
                    <div class="checkbox-group" id="group-triplet-patterns">
                        <div class="checkbox-item">
                            <input type="checkbox" id="triplet_pattern1" value="triplet_pattern1" class="pattern-triplet">
                            <label for="triplet_pattern1">8+8+8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="triplet_pattern2" value="triplet_pattern2" class="pattern-triplet">
                            <label for="triplet_pattern2">8+R8+8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="triplet_pattern3" value="triplet_pattern3" class="pattern-triplet">
                            <label for="triplet_pattern3">R8+8+8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="triplet_pattern4" value="triplet_pattern4" class="pattern-triplet">
                            <label for="triplet_pattern4">8+8+R8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="triplet_pattern5" value="triplet_pattern5" class="pattern-triplet">
                            <label for="triplet_pattern5">8+R8+R8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="triplet_pattern6" value="triplet_pattern6" class="pattern-triplet">
                            <label for="triplet_pattern6">R8+8+R8</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="triplet_pattern7" value="triplet_pattern7" class="pattern-triplet">
                            <label for="triplet_pattern7">R8+R8+8</label>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        // PWA Installation
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').classList.add('show');
        });
        
        async function installApp() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            document.getElementById('installBanner').classList.remove('show');
        }

        // No initialization needed for Web Audio API (built-in)
        async function initializeBass() {
            console.log("✅ Using Web Audio API (no loading required)");
        }
        
        // Rhythm patterns database - each pattern = exactly 4 sixteenths (1 quarter note)
        // ABC notation uses L:1/16 so numbers represent sixteenth note durations
        // E,4 = whole note (4 sixteenths), E,2 = eighth (2 sixteenths), E, = sixteenth
        const rhythmPatterns = {
            // Simple (3 patterns)
            simple_whole: { abc: 'z4' },
            simple_quarter: { abc: 'E,4' },
            simple_sixteenths: { abc: 'E,E,E,E,' },
            
            // 1 Note (6 patterns)
            '1note_pattern1': { abc: 'zE,z2' },
            '1note_pattern2': { abc: 'E,z3' },
            '1note_pattern3': { abc: 'z3E,' },
            '1note_pattern4': { abc: 'z2E,z' },
            '1note_pattern5': { abc: 'z2E,2' },
            '1note_pattern6': { abc: 'E,2z2' },
            
            // 2 Notes (11 patterns)
            '2note_pattern1': { abc: 'z2E,E,' },
            '2note_pattern2': { abc: 'E,E,z2' },
            '2note_pattern3': { abc: 'zE,E,z' },
            '2note_pattern4': { abc: 'E,E,3' },
            '2note_pattern5': { abc: 'E,3E,' },
            '2note_pattern6': { abc: 'E,z2E,' },
            '2note_pattern7': { abc: 'E,2E,2' },
            '2note_pattern8': { abc: 'zE,zE,' },
            '2note_pattern9': { abc: 'E,zE,z' },
            '2note_pattern10': { abc: 'E,E,2z' },
            '2note_pattern11': { abc: 'zE,E,2' },
            
            // 3 Notes (6 patterns)
            '3note_pattern1': { abc: 'zE,E,E,' },
            '3note_pattern2': { abc: 'E,E,E,z' },
            '3note_pattern3': { abc: 'E,E,E,2' },
            '3note_pattern4': { abc: 'E,2E,E,' },
            '3note_pattern5': { abc: 'E,E,2E,' },
            '3note_pattern6': { abc: 'E,E,zE,' },
            
            // Triplets (7 patterns)
            triplet_pattern1: { abc: '(3E,2E,2E,2' },
            triplet_pattern2: { abc: '(3E,2z2E,2' },
            triplet_pattern3: { abc: '(3z2E,2E,2' },
            triplet_pattern4: { abc: '(3E,2E,2z2' },
            triplet_pattern5: { abc: '(3E,2z2z2' },
            triplet_pattern6: { abc: '(3z2E,2z2' },
            triplet_pattern7: { abc: '(3z2z2E,2' }
        };

        let currentABC = '';
        let audioContext = null;
        let isPlaying = false;
        let isInitiatingPlayback = false; // Prevent overlapping play attempts
        let currentPage = 1;
        let currentPatternStructure = []; // Store the pattern structure for redrawing
        let scheduledSources = []; // Track all scheduled audio sources for stopping
        let playbackTimeout = null; // Track the timeout for automatic stop
        let highlightTimeouts = []; // Track all cursor highlight timeouts
        let countInTimeouts = []; // Track count-in display timeouts
        let visualObj = null; // Store the visual object for cursor animation
        let audioReady = true; // Audio is always ready with Web Audio API

        function redrawWithNewNote() {
            // Only redraw if we have a current pattern
            if (currentPatternStructure.length === 0) return;
            
            const bassNote = document.getElementById('bassNote').value;
            
            let abcNotation = `X:1
M:4/4
L:1/16
%%stretchlast
K:C clef=bass
`;
            
            // Reconstruct bars with new note
            const rhythmBars = currentPatternStructure.map((barPatterns, index) => {
                const bar = barPatterns.join(' ');
                if (index < currentPatternStructure.length - 1) {
                    return bar + ' |$';
                }
                return bar + ' |';
            }).join('\n');
            
            abcNotation += rhythmBars + ']';
            
            // Replace placeholder note (E,) with actual bass note
            abcNotation = abcNotation.replace(/E,/g, bassNote);
            
            currentABC = abcNotation;
            
            // Render music and store visual object for cursor
            visualObj = ABCJS.renderAbc("music", currentABC, {
                responsive: "resize",
                staffwidth: window.innerWidth - 72,
                add_classes: true
            })[0];
            
            showStatus('Redrawn with ' + bassNote, 'success');
        }

        function togglePage() {
            const page1 = document.getElementById('page1');
            const page2 = document.getElementById('page2');
            const navButton = document.getElementById('navButton');
            
            if (currentPage === 1) {
                page1.classList.remove('active');
                page2.classList.add('active');
                navButton.innerHTML = '<span style="color: white; font-size: 24px; font-weight: bold; line-height: 1;">←</span>';
                currentPage = 2;
            } else {
                page2.classList.remove('active');
                page1.classList.add('active');
                navButton.innerHTML = '<span style="color: white; font-size: 20px; font-weight: bold; line-height: 1;">⋯</span>';
                currentPage = 1;
            }
        }
        
        function toggleGroup(groupName, event) {
            const groupCheckbox = document.getElementById(`group-${groupName}`);
            const patternCheckboxes = document.querySelectorAll(`.pattern-${groupName}`);
            
            // If the click was directly on the checkbox, it's already been toggled by default behavior
            // If it was on the label, we need to toggle it
            const clickedCheckbox = event && event.target.type === 'checkbox';
            
            if (!clickedCheckbox) {
                groupCheckbox.checked = !groupCheckbox.checked;
            }
            
            // Set all pattern checkboxes to match the group checkbox state
            patternCheckboxes.forEach(checkbox => {
                checkbox.checked = groupCheckbox.checked;
            });
        }

        function getSelectedPatterns() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes)
                .filter(cb => {
                    // Only include checkboxes that have a value and it's a valid pattern ID
                    // Pattern IDs contain 'pattern' or 'simple_' prefix
                    return cb.value && (
                        cb.value.includes('pattern') || 
                        cb.value.startsWith('simple_')
                    );
                })
                .map(cb => cb.value);
        }

        function generateRhythm() {
            const selectedPatterns = getSelectedPatterns();
            
            if (selectedPatterns.length === 0) {
                showStatus('Please select at least one rhythm pattern from settings', 'error');
                return;
            }

            console.log(`Generating rhythm with ${selectedPatterns.length} patterns:`, selectedPatterns);

            const barCount = parseInt(document.getElementById('barCount').value);
            const bassNote = document.getElementById('bassNote').value;
            
            let abcNotation = `X:1
M:4/4
L:1/16
%%stretchlast
K:C clef=bass
`;
            let bars = [];
            
            // Each bar needs exactly 4 patterns (each pattern = 4 sixteenths = 1 quarter note)
            // Total: 4 patterns × 4 sixteenths = 16 sixteenths per bar (4/4 time)
            currentPatternStructure = []; // Reset pattern structure
            for (let i = 0; i < barCount; i++) {
                let barPatterns = [];
                for (let j = 0; j < 4; j++) {
                    const randomPattern = selectedPatterns[Math.floor(Math.random() * selectedPatterns.length)];
                    const pattern = rhythmPatterns[randomPattern];
                    if (!pattern) {
                        console.error('Pattern not found:', randomPattern);
                        showStatus(`Error: Pattern "${randomPattern}" not found`, 'error');
                        return;
                    }
                    barPatterns.push(pattern.abc);
                }
                bars.push(barPatterns.join(' '));
                currentPatternStructure.push(barPatterns); // Store for redrawing
            }
            
            // Join bars with line breaks using $ which forces new line in rendered music
            // Don't add $ to the last bar to avoid extra empty line
            const rhythmBars = bars.map((bar, index) => {
                if (index < bars.length - 1) {
                    return bar + ' |$';
                }
                return bar + ' |';
            }).join('\n');
            
            abcNotation += rhythmBars + ']';
            
            // Replace placeholder note (E,) with actual bass note
            abcNotation = abcNotation.replace(/E,/g, bassNote);
            
            currentABC = abcNotation;
            
            // Render music and store visual object for cursor
            document.querySelector('.empty-state').style.display = 'none';
            document.getElementById('music').style.display = 'block';
            
            visualObj = ABCJS.renderAbc("music", currentABC, {
                responsive: "resize",
                staffwidth: window.innerWidth - 72,
                add_classes: true
            })[0];
            
            showStatus('Rhythm generated successfully!', 'success');
        }

        // Parse ABC notation to extract timing
        function parseABCNotes(abc) {
            const lines = abc.split('\n');
            // Get all lines that contain notes (skip header lines)
            const noteLines = lines.filter(line => 
                !line.startsWith('X:') && 
                !line.startsWith('T:') && 
                !line.startsWith('M:') && 
                !line.startsWith('L:') && 
                !line.startsWith('Q:') && 
                !line.startsWith('K:') &&
                !line.startsWith('%') &&
                line.trim().length > 0
            );
            
            const notes = [];
            let currentTime = 0;
            
            // Process all note lines together
            noteLines.forEach(noteLine => {
                // Remove the bar lines and split by spaces
                const cleanLine = noteLine.replace(/\|/g, '').replace(/\$/g, '').replace(/\]/g, '').trim();
                const tokens = cleanLine.split(/\s+/);
                
                tokens.forEach(token => {
                    // Check if this token starts with a triplet marker
                    let tripletCount = 0;
                    if (token.startsWith('(3')) {
                        tripletCount = 3; // Next 3 notes are triplets
                        token = token.substring(2); // Remove (3 prefix
                    }
                    
                    // Count characters in token to determine duration
                    let i = 0;
                    let notesInToken = 0;
                    
                    while (i < token.length) {
                        const char = token[i];
                        
                        if (char === 'z') {
                            // Rest - check if followed by number
                            let duration = 1;
                            if (i + 1 < token.length && /[0-9]/.test(token[i + 1])) {
                                duration = parseInt(token[i + 1]);
                                i += 2;
                            } else {
                                i += 1;
                            }
                            // Apply triplet ratio if this is one of the triplet notes
                            const isTriplet = tripletCount > 0 && notesInToken < tripletCount;
                            const actualDuration = isTriplet ? duration * (2/3) : duration;
                            currentTime += actualDuration;
                            notesInToken++;
                        } else if (char === 'E' || char === 'A' || char === 'D' || char === 'G' || char === 'C' || char === 'F' || char === 'B') {
                            // Note - check for commas
                            let pitch = char;
                            while (i + 1 < token.length && token[i + 1] === ',') {
                                pitch += ',';
                                i++;
                            }
                            i++;
                            
                            // Check if followed by number (duration multiplier)
                            let duration = 1;
                            if (i < token.length && /[0-9]/.test(token[i])) {
                                duration = parseInt(token[i]);
                                i += 1;
                            }
                            
                            // Apply triplet ratio if this is one of the triplet notes
                            const isTriplet = tripletCount > 0 && notesInToken < tripletCount;
                            const actualDuration = isTriplet ? duration * (2/3) : duration;
                            
                            notes.push({
                                pitch: pitch,
                                start: currentTime,
                                duration: actualDuration
                            });
                            
                            currentTime += actualDuration;
                            notesInToken++;
                        } else {
                            i += 1;
                        }
                    }
                });
            });
            
            return { notes, totalDuration: currentTime };
        }

        // Convert ABC pitch to frequency (bass clef - E, is E2 in scientific pitch notation)
        function pitchToFrequency(pitch) {
            // Map of ABC notation to frequencies (in Hz) - proper bass clef range
            // E, in bass clef = E2 = 82.41 Hz
            const frequencies = {
                'E,,': 41.20,   // E1 (octave below bass E)
                'F,,': 43.65,   // F1
                'G,,': 49.00,   // G1
                'A,,': 55.00,   // A1
                'B,,': 61.74,   // B1
                'C,': 65.41,    // C2
                'D,': 73.42,    // D2
                'E,': 82.41     // E2 (bass clef low E)
            };
            
            return frequencies[pitch] || 82.41; // Default to E2
        }

        // Create an improved bass note using Web Audio API
        function createBassNote(ctx, frequency, startTime, duration) {
            // Create oscillator for fundamental frequency
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            const filter = ctx.createBiquadFilter();
            
            // Bass sound configuration
            osc.type = 'triangle';
            osc.frequency.value = frequency;
            
            // Low-pass filter to remove harsh highs
            filter.type = 'lowpass';
            filter.frequency.value = frequency * 4;
            filter.Q.value = 1;
            
            // Connect: oscillator → filter → gain → destination
            osc.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            // ADSR envelope for natural sound
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(0.6, startTime + 0.01); // Attack
            gainNode.gain.exponentialRampToValueAtTime(0.4, startTime + 0.05); // Decay
            gainNode.gain.setValueAtTime(0.4, startTime + duration * 0.7); // Sustain
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration); // Release
            
            osc.start(startTime);
            osc.stop(startTime + duration);
            
            scheduledSources.push(osc);
            return osc;
        }
        
        // Convert frequency to MIDI note number
        function frequencyToMidi(freq) {
            // MIDI note number = 12 * log2(freq / 440) + 69
            // For common bass notes:
            const notes = {
                43.65: 41,   // F1
                49.00: 43,   // G1
                55.00: 45,   // A1
                61.74: 47,   // B1
                65.41: 48,   // C2
                73.42: 50,   // D2
                82.41: 52    // E2 (default)
            };
            
            // Find closest match
            let closest = 52;
            let minDiff = Math.abs(freq - 82.41);
            
            for (const [f, midi] of Object.entries(notes)) {
                const diff = Math.abs(freq - parseFloat(f));
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = midi;
                }
            }
            
            return closest;
        }
        
        // Convert frequency to note name (e.g., 82.41 -> "E2")
        function frequencyToNote(freq) {
            const notes = {
                43.65: "F1",   // F,,
                49.00: "G1",   // G,,
                55.00: "A1",   // A,,
                61.74: "B1",   // B,,
                65.41: "C2",   // C,
                73.42: "D2",   // D,
                82.41: "E2"    // E, (default)
            };
            
            // Find closest match
            let closest = "E2";
            let minDiff = Math.abs(freq - 82.41);
            
            for (const [f, note] of Object.entries(notes)) {
                const diff = Math.abs(freq - parseFloat(f));
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = note;
                }
            }
            
            return closest;
        }
        
        // Play metronome click
        function playClick(time, isDownbeat) {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = isDownbeat ? 1200 : 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.2, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
            
            oscillator.start(time);
            oscillator.stop(time + 0.05);
            
            scheduledSources.push(oscillator);
        }

        // Schedule all audio
        function scheduleAudio(tempo, metronomeEnabled, barCount) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const startTime = audioContext.currentTime + 0.1;
            
            // Parse the ABC notation
            const { notes, totalDuration } = parseABCNotes(currentABC);
            
            // Calculate beat duration (quarter note in seconds)
            const beatDuration = 60 / tempo;
            const sixteenthDuration = beatDuration / 4; // Each 16th note duration
            
            // Schedule notes
            notes.forEach(note => {
                const freq = pitchToFrequency(note.pitch);
                const noteStart = startTime + (note.start * sixteenthDuration);
                const noteDuration = note.duration * sixteenthDuration;
                
                createBassNote(audioContext, freq, noteStart, noteDuration * 0.9); // Slight gap
            });
            
            // Schedule metronome clicks
            if (metronomeEnabled) {
                // Use the actual bar count passed in
                const totalBeats = barCount * 4; // 4 beats per bar in 4/4 time
                
                for (let i = 0; i < totalBeats; i++) {
                    const clickTime = startTime + (i * beatDuration);
                    const isDownbeat = (i % 4 === 0); // Downbeat on every 4th beat
                    playClick(clickTime, isDownbeat);
                }
            }
            
            return totalDuration * sixteenthDuration;
        }

        async function playRhythm() {
            if (!currentABC) {
                showStatus('Generate a rhythm first', 'error');
                return;
            }
            
            // If already playing, stop it
            if (isPlaying) {
                stopPlayback();
                return;
            }
            
            // Prevent multiple simultaneous play attempts
            if (isInitiatingPlayback) {
                console.log('Playback already starting, ignoring duplicate request');
                return;
            }
            
            try {
                isInitiatingPlayback = true;
                
                // Ensure everything is fully stopped first
                stopPlayback();
                
                // Small delay to ensure cleanup is complete
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Create audio context if needed
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Resume audio context if suspended
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                isPlaying = true;
                
                // Change button to "Stop"
                const playButton = document.querySelector('.btn-play');
                playButton.innerHTML = '⬛ Stop';
                
                // Disable generate button during playback
                const generateButton = document.getElementById('generateButton');
                if (generateButton) {
                    generateButton.disabled = true;
                }
                
                showStatus('Playing...', 'playing');
                
                const tempo = parseInt(document.getElementById('tempo').value);
                const barCount = parseInt(document.getElementById('barCount').value);
                const countInEnabled = document.getElementById('countIn').checked;
                
                // Clear any previously scheduled sources
                scheduledSources = [];
                
                // Get audio context
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const beatDuration = 60 / tempo;
                let countInDelay = 0;
                
                // Clear any previous count-in timeouts
                countInTimeouts.forEach(timeout => clearTimeout(timeout));
                countInTimeouts = [];
                
                // Schedule count-in clicks if enabled
                if (countInEnabled) {
                    const startTime = audioContext.currentTime + 0.1;
                    
                    // Display count-in numbers
                    showStatus('4', 'playing');
                    countInTimeouts.push(setTimeout(() => { if (isPlaying) showStatus('3', 'playing'); }, beatDuration * 1000));
                    countInTimeouts.push(setTimeout(() => { if (isPlaying) showStatus('2', 'playing'); }, beatDuration * 2000));
                    countInTimeouts.push(setTimeout(() => { if (isPlaying) showStatus('1', 'playing'); }, beatDuration * 3000));
                    countInTimeouts.push(setTimeout(() => { if (isPlaying) showStatus('Playing...', 'playing'); }, beatDuration * 4000));
                    
                    // Schedule audio clicks
                    for (let i = 0; i < 4; i++) {
                        const clickTime = startTime + (i * beatDuration);
                        const isDownbeat = (i === 0);
                        playClick(clickTime, isDownbeat);
                    }
                    // Delay the rhythm playback by 4 beats
                    countInDelay = 4 * beatDuration * 1000;
                } else {
                    showStatus('Playing...', 'playing');
                }
                
                // Function to play one iteration
                const playIteration = () => {
                    if (!isPlaying) return;
                    
                    // Clear any pending highlight timeouts from previous iteration
                    highlightTimeouts.forEach(timeout => clearTimeout(timeout));
                    highlightTimeouts = [];
                    
                    // Clear previous sources (except count-in clicks)
                    const countInSources = scheduledSources.slice(0, countInEnabled ? 4 : 0);
                    scheduledSources = countInSources;
                    
                    // Schedule all audio
                    const totalDuration = scheduleAudio(tempo, true, barCount);
                    
                    // Highlight notes as they play
                    if (visualObj && visualObj.engraver && visualObj.engraver.staffgroups) {
                        const { notes } = parseABCNotes(currentABC);
                        const sixteenthDuration = beatDuration / 4;
                        
                        notes.forEach((note, index) => {
                            const highlightTime = note.start * sixteenthDuration * 1000;
                            const clearTime = (note.start + note.duration) * sixteenthDuration * 1000;
                            
                            const highlightTimeout = setTimeout(() => {
                                if (!isPlaying) return;
                                const allNotes = document.querySelectorAll('.abcjs-note');
                                if (allNotes[index]) {
                                    allNotes[index].classList.add('abcjs-cursor');
                                }
                            }, highlightTime);
                            highlightTimeouts.push(highlightTimeout);
                            
                            const clearTimeout = setTimeout(() => {
                                // Always clear the highlight, even if stopped
                                const allNotes = document.querySelectorAll('.abcjs-note');
                                if (allNotes[index]) {
                                    allNotes[index].classList.remove('abcjs-cursor');
                                }
                            }, clearTime);
                            highlightTimeouts.push(clearTimeout);
                        });
                    }
                    
                    // Auto-stop after this iteration finishes
                    playbackTimeout = setTimeout(() => {
                        stopPlayback();
                    }, totalDuration * 1000 + 100);
                };
                
                // Start the first iteration after count-in
                if (countInDelay > 0) {
                    setTimeout(() => {
                        if (isPlaying) {
                            playIteration();
                        }
                        isInitiatingPlayback = false; // Reset flag after playback starts
                    }, countInDelay);
                } else {
                    playIteration();
                    isInitiatingPlayback = false; // Reset flag after playback starts
                }
                
            } catch (error) {
                console.error("Play error:", error);
                isInitiatingPlayback = false; // Reset flag on error
                stopPlayback();
                showStatus('Error playing: ' + error.message, 'error');
            }
        }
        
        function stopPlayback() {
            // Reset flags
            isPlaying = false;
            isInitiatingPlayback = false;
            
            // Clear all note highlights
            const allNotes = document.querySelectorAll('.abcjs-note');
            allNotes.forEach(note => note.classList.remove('abcjs-cursor'));
            
            // Clear all highlight timeouts
            highlightTimeouts.forEach(timeout => clearTimeout(timeout));
            highlightTimeouts = [];
            
            // Clear count-in display timeouts
            countInTimeouts.forEach(timeout => clearTimeout(timeout));
            countInTimeouts = [];
            
            // Stop all scheduled oscillators immediately
            if (audioContext) {
                const now = audioContext.currentTime;
                scheduledSources.forEach(source => {
                    try {
                        source.stop(now);
                    } catch (e) {
                        // Already stopped
                    }
                });
            }
            scheduledSources = [];
            
            // Clear the timeout
            if (playbackTimeout) {
                clearTimeout(playbackTimeout);
                playbackTimeout = null;
            }
            
            const musicDisplay = document.getElementById('musicDisplay');
            musicDisplay.classList.remove('playing');
            
            // Change button back to "Play"
            const playButton = document.querySelector('.btn-play');
            if (playButton) {
                playButton.innerHTML = '▶ Play';
            }
            
            // Re-enable generate button
            const generateButton = document.getElementById('generateButton');
            if (generateButton) {
                generateButton.disabled = false;
            }
            
            showStatus('Playback stopped', 'success');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            if (type !== 'playing') {
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = 'status';
                }, 3000);
            }
        }

        // Handle window resize for responsive music rendering
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (currentABC) {
                    visualObj = ABCJS.renderAbc("music", currentABC, {
                        responsive: "resize",
                        staffwidth: window.innerWidth - 72,
                        add_classes: true
                    })[0];
                }
            }, 250);
        });

        // Prevent zoom on double-tap for iOS
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Generate a rhythm automatically on page load
        window.addEventListener('load', () => {
            // Wait for ABCJS to be fully loaded
            const tryGenerate = () => {
                if (typeof ABCJS !== 'undefined') {
                    try {
                        generateRhythm();
                    } catch (error) {
                        console.error('Auto-generate failed:', error);
                        // Retry once after a longer delay
                        setTimeout(() => {
                            try {
                                generateRhythm();
                            } catch (e) {
                                console.error('Auto-generate retry failed:', e);
                            }
                        }, 500);
                    }
                } else {
                    // ABCJS not loaded yet, wait and retry
                    setTimeout(tryGenerate, 100);
                }
            };
            
            // Start trying after a short delay
            setTimeout(tryGenerate, 150);
        });

        // PWA installation handling (no Service Worker needed for basic PWA functionality)
        console.log('Rhythm Practice PWA loaded - ready to install to home screen!');
    </script>
</body>
</html>