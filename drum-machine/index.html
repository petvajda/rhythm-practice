<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Grid Beats</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdyaWQgQmVhdHMiLAogICJzaG9ydF9uYW1lIjogIkdyaWQgQmVhdHMiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJvcmllbnRhdGlvbiI6ICJsYW5kc2NhcGUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwYTBhMGEiLAogICJ0aGVtZV9jb2xvciI6ICIjMGEwYTBhIgp9">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Space+Mono:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --neon-cyan: #00fff5;
            --neon-pink: #ff006e;
            --neon-yellow: #ffbe0b;
            --bg-dark: #0a0a0a;
            --bg-darker: #050505;
            --grid-line: #1a1a1a;
        }

        body {
            background: var(--bg-dark);
            font-family: 'Space Mono', monospace;
            color: var(--neon-cyan);
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Animated background grid */
        body::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
            animation: gridScroll 20s linear infinite;
            pointer-events: none;
        }

        @keyframes gridScroll {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* Glow effects */
        @keyframes pulseGlow {
            0%, 100% { filter: drop-shadow(0 0 8px currentColor); }
            50% { filter: drop-shadow(0 0 20px currentColor); }
        }

        .container {
            width: 100%;
            max-width: 100%;
            padding: clamp(2px, 0.5vw, 4px);
            display: flex;
            flex-direction: column;
            gap: clamp(2px, 0.5vh, 4px);
            position: relative;
            z-index: 1;
            /* Prevent layout shifts */
            min-height: 100vh;
            justify-content: center;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: clamp(2px, 0.5vh, 4px);
            background: linear-gradient(135deg, rgba(0, 255, 245, 0.1), rgba(255, 0, 110, 0.1));
            border: 2px solid var(--neon-cyan);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 245, 0.3);
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(20px, 4vw, 32px);
            font-weight: 900;
            letter-spacing: 3px;
            background: linear-gradient(45deg, var(--neon-cyan), var(--neon-pink), var(--neon-yellow));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        .tempo-control {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 16px);
        }

        .tempo-label {
            font-size: clamp(12px, 2.5vw, 16px);
            color: var(--neon-yellow);
            font-weight: 700;
            text-shadow: 0 0 10px var(--neon-yellow);
        }

        .tempo-input {
            width: clamp(60px, 15vw, 80px);
            padding: clamp(4px, 1vh, 8px);
            background: var(--bg-darker);
            border: 2px solid var(--neon-pink);
            border-radius: 4px;
            color: var(--neon-cyan);
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(14px, 3vw, 18px);
            font-weight: 700;
            text-align: center;
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.3);
        }

        .tempo-input:focus {
            outline: none;
            box-shadow: 0 0 25px rgba(255, 0, 110, 0.6);
        }

        .tempo-btn {
            width: clamp(32px, 8vw, 40px);
            height: clamp(32px, 8vw, 40px);
            padding: 0;
            background: var(--bg-darker);
            border: 2px solid var(--neon-cyan);
            border-radius: 4px;
            color: var(--neon-cyan);
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(18px, 4vw, 24px);
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 255, 245, 0.3);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tempo-btn:hover {
            background: rgba(0, 255, 245, 0.1);
            box-shadow: 0 0 25px rgba(0, 255, 245, 0.6);
            transform: scale(1.05);
        }

        .tempo-btn:active {
            transform: scale(0.95);
        }

        /* Drum Grid */
        .drum-grid {
            display: flex;
            flex-direction: column;
            gap: clamp(2px, 0.5vh, 4px);
            padding: clamp(2px, 0.5vh, 4px);
            background: rgba(10, 10, 10, 0.8);
            border: 2px solid var(--neon-pink);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.2);
            /* Prevent layout shift during playback */
            contain: layout style;
        }

        .drum-row {
            display: flex;
            gap: clamp(4px, 1vw, 8px);
            align-items: center;
            /* Prevent row reflow */
            contain: layout;
        }

        .row-label {
            width: clamp(50px, 12vw, 80px);
            font-size: clamp(10px, 2vw, 14px);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--neon-yellow);
            text-shadow: 0 0 8px var(--neon-yellow);
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }

        .row-label-text {
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .row-label-text.clickable:hover {
            color: var(--neon-pink);
            text-shadow: 0 0 12px var(--neon-pink);
        }

        /* Snare selection dialog */
        .snare-dialog-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .snare-dialog-overlay.show {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .snare-dialog {
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95), rgba(20, 20, 20, 0.95));
            border: 3px solid var(--neon-pink);
            border-radius: 12px;
            padding: clamp(20px, 4vw, 32px);
            box-shadow: 0 0 40px rgba(255, 0, 110, 0.6);
            min-width: clamp(250px, 60vw, 350px);
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from { 
                transform: translateY(-30px) scale(0.95);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .snare-dialog-title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(18px, 4vw, 24px);
            font-weight: 900;
            color: var(--neon-cyan);
            text-align: center;
            margin-bottom: clamp(16px, 3vh, 24px);
            text-shadow: 0 0 15px var(--neon-cyan);
        }

        .snare-options {
            display: flex;
            flex-direction: column;
            gap: clamp(12px, 2vh, 16px);
            margin-bottom: clamp(16px, 3vh, 24px);
        }

        .snare-option {
            padding: clamp(12px, 2.5vh, 16px);
            background: var(--bg-darker);
            border: 2px solid rgba(0, 255, 245, 0.3);
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: clamp(14px, 3vw, 18px);
            font-weight: 700;
            color: var(--neon-cyan);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
        }

        .snare-option:hover {
            border-color: var(--neon-pink);
            background: rgba(255, 0, 110, 0.1);
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.4);
        }

        .snare-option.selected {
            border-color: var(--neon-yellow);
            background: linear-gradient(135deg, rgba(0, 255, 245, 0.2), rgba(255, 0, 110, 0.2));
            box-shadow: 0 0 25px rgba(255, 190, 11, 0.5);
        }

        .snare-option.selected::before {
            content: '✓';
            position: absolute;
            right: 12px;
            color: var(--neon-yellow);
            font-size: 20px;
        }

        .snare-dialog-close {
            width: 100%;
            padding: clamp(10px, 2vh, 14px);
            background: var(--bg-darker);
            border: 2px solid var(--neon-cyan);
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(12px, 2.5vw, 16px);
            font-weight: 700;
            color: var(--neon-cyan);
            cursor: pointer;
            transition: all 0.2s;
        }

        .snare-dialog-close:hover {
            background: rgba(0, 255, 245, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 245, 0.4);
        }

        .snare-dialog-close:active {
            transform: scale(0.95);
        }

        .steps {
            display: flex;
            gap: clamp(4px, 1vw, 8px);
            flex: 1;
        }

        .step-group {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(2px, 0.5vw, 4px);
            flex: 1;
            padding: clamp(3px, 0.8vw, 6px);
            background: rgba(0, 255, 245, 0.03);
            border: 1px solid rgba(0, 255, 245, 0.2);
            border-radius: 6px;
            position: relative;
        }

        .step-group::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 6px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(0, 255, 245, 0.3), rgba(255, 0, 110, 0.3));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.5;
        }

        .step {
            aspect-ratio: 1;
            width: 100%;
            background: var(--bg-darker);
            border: 2px solid rgba(0, 255, 245, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            /* Prevent layout shift during animations */
            will-change: transform;
            transform: translateZ(0);
            /* Center text for bass notes */
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: clamp(10px, 2.5vw, 14px);
            color: var(--bg-dark);
        }

        .step::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, transparent 30%, var(--bg-darker) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .step:active {
            transform: scale(0.9) translateZ(0);
        }

        .step.active {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
            border-color: var(--neon-yellow);
            box-shadow: 
                0 0 20px rgba(0, 255, 245, 0.6),
                inset 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* Bass note letters - make visible on active steps */
        .drum-row[data-sound="bass"] .step.active {
            color: var(--bg-dark);
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        /* Hi-hat closed state (default active) */
        .drum-row[data-sound="hihat"] .step.active {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
            border-color: var(--neon-yellow);
        }

        /* Hi-hat open state */
        .drum-row[data-sound="hihat"] .step.active.open {
            background: linear-gradient(135deg, var(--neon-yellow), #ff6b00);
            border-color: #ff6b00;
            box-shadow: 
                0 0 20px rgba(255, 107, 0, 0.6),
                inset 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .step.active::before {
            opacity: 1;
        }

        .step.playing {
            /* Use transform instead of scale to prevent layout shift */
            transform: scale(1.15) translateZ(0);
            box-shadow: 
                0 0 30px var(--neon-yellow),
                inset 0 0 20px rgba(255, 255, 255, 0.5);
        }

        @keyframes stepPulse {
            0%, 100% { transform: scale(1) translateZ(0); }
            50% { transform: scale(1.15) translateZ(0); }
        }

        .step.current-beat {
            border-color: var(--neon-yellow);
            box-shadow: 0 0 15px var(--neon-yellow);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: clamp(12px, 3vw, 24px);
            justify-content: center;
            padding: clamp(2px, 0.5vh, 4px);
        }

        .control-btn {
            padding: clamp(6px, 1.5vh, 10px) clamp(12px, 3vw, 24px);
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(14px, 3vw, 20px);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 3px solid;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            background: var(--bg-darker);
        }

        .control-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .control-btn:hover::before {
            transform: translateX(100%);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .play-btn {
            color: var(--neon-cyan);
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 245, 0.4);
        }

        .play-btn:hover {
            background: rgba(0, 255, 245, 0.2);
            box-shadow: 0 0 30px rgba(0, 255, 245, 0.6);
        }

        .play-btn.playing {
            color: var(--neon-pink);
            border-color: var(--neon-pink);
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.4);
        }

        .play-btn.playing:hover {
            background: rgba(255, 0, 110, 0.2);
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.6);
        }

        .clear-btn {
            color: var(--neon-yellow);
            border-color: var(--neon-yellow);
            box-shadow: 0 0 20px rgba(255, 190, 11, 0.4);
        }

        .clear-btn:hover {
            background: rgba(255, 190, 11, 0.2);
            box-shadow: 0 0 30px rgba(255, 190, 11, 0.6);
        }

        /* Portrait mode warning */
        @media (orientation: portrait) {
            body::after {
                content: 'Please rotate your device to landscape mode';
                position: fixed;
                inset: 0;
                background: var(--bg-dark);
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 32px;
                text-align: center;
                font-size: 20px;
                font-weight: 700;
                color: var(--neon-cyan);
                z-index: 9999;
            }
        }

        /* Loading state */
        .loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(16px, 3vw, 24px);
            color: var(--neon-cyan);
            text-align: center;
            z-index: 1000;
            padding: 24px;
            background: rgba(10, 10, 10, 0.9);
            border: 2px solid var(--neon-cyan);
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 255, 245, 0.5);
        }

        .loading-message.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="loading-message" id="loading">Loading sounds...</div>

    <div class="container">
        <div class="header">
            <div class="logo">GRID BEATS</div>
            <div class="tempo-control">
                <label class="tempo-label">BPM</label>
                <button class="tempo-btn" id="bpmDown">−</button>
                <input type="number" class="tempo-input" id="bpm" value="100" min="40" max="240" step="1">
                <button class="tempo-btn" id="bpmUp">+</button>
            </div>
        </div>

        <div class="drum-grid">
            <div class="drum-row" data-sound="kick">
                <div class="row-label">
                    <div class="row-label-text clickable" id="kickLabel">Kick</div>
                </div>
                <div class="steps">
                    <div class="step-group">
                        <div class="step" data-step="0"></div>
                        <div class="step" data-step="1"></div>
                        <div class="step" data-step="2"></div>
                        <div class="step" data-step="3"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="4"></div>
                        <div class="step" data-step="5"></div>
                        <div class="step" data-step="6"></div>
                        <div class="step" data-step="7"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="8"></div>
                        <div class="step" data-step="9"></div>
                        <div class="step" data-step="10"></div>
                        <div class="step" data-step="11"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="12"></div>
                        <div class="step" data-step="13"></div>
                        <div class="step" data-step="14"></div>
                        <div class="step" data-step="15"></div>
                    </div>
                </div>
            </div>

            <div class="drum-row" data-sound="snare">
                <div class="row-label">
                    <div class="row-label-text clickable" id="snareLabel">Snare</div>
                </div>
                <div class="steps">
                    <div class="step-group">
                        <div class="step" data-step="0"></div>
                        <div class="step" data-step="1"></div>
                        <div class="step" data-step="2"></div>
                        <div class="step" data-step="3"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="4"></div>
                        <div class="step" data-step="5"></div>
                        <div class="step" data-step="6"></div>
                        <div class="step" data-step="7"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="8"></div>
                        <div class="step" data-step="9"></div>
                        <div class="step" data-step="10"></div>
                        <div class="step" data-step="11"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="12"></div>
                        <div class="step" data-step="13"></div>
                        <div class="step" data-step="14"></div>
                        <div class="step" data-step="15"></div>
                    </div>
                </div>
            </div>

            <div class="drum-row" data-sound="hihat">
                <div class="row-label">
                    <div class="row-label-text">Hi-Hat</div>
                </div>
                <div class="steps">
                    <div class="step-group">
                        <div class="step" data-step="0"></div>
                        <div class="step" data-step="1"></div>
                        <div class="step" data-step="2"></div>
                        <div class="step" data-step="3"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="4"></div>
                        <div class="step" data-step="5"></div>
                        <div class="step" data-step="6"></div>
                        <div class="step" data-step="7"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="8"></div>
                        <div class="step" data-step="9"></div>
                        <div class="step" data-step="10"></div>
                        <div class="step" data-step="11"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="12"></div>
                        <div class="step" data-step="13"></div>
                        <div class="step" data-step="14"></div>
                        <div class="step" data-step="15"></div>
                    </div>
                </div>
            </div>

            <div class="drum-row" data-sound="bass">
                <div class="row-label">
                    <div class="row-label-text">Bass</div>
                </div>
                <div class="steps">
                    <div class="step-group">
                        <div class="step" data-step="0"></div>
                        <div class="step" data-step="1"></div>
                        <div class="step" data-step="2"></div>
                        <div class="step" data-step="3"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="4"></div>
                        <div class="step" data-step="5"></div>
                        <div class="step" data-step="6"></div>
                        <div class="step" data-step="7"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="8"></div>
                        <div class="step" data-step="9"></div>
                        <div class="step" data-step="10"></div>
                        <div class="step" data-step="11"></div>
                    </div>
                    <div class="step-group">
                        <div class="step" data-step="12"></div>
                        <div class="step" data-step="13"></div>
                        <div class="step" data-step="14"></div>
                        <div class="step" data-step="15"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn play-btn" id="playBtn">Play</button>
            <button class="control-btn clear-btn" id="clearBtn">Clear</button>
            <button class="control-btn clear-btn" id="resetBtn">Reset</button>
        </div>
    </div>

    <!-- Snare Selection Dialog -->
    <div class="snare-dialog-overlay" id="snareDialogOverlay">
        <div class="snare-dialog">
            <div class="snare-dialog-title">SELECT SNARE TYPE</div>
            <div class="snare-options">
                <div class="snare-option selected" data-snare-type="rytm-classic">
                    CLASSIC
                </div>
                <div class="snare-option" data-snare-type="rytm-hard">
                    HARD
                </div>
                <div class="snare-option" data-snare-type="rytm-bright">
                    BRIGHT
                </div>
            </div>
            <button class="snare-dialog-close" id="snareDialogClose">CLOSE</button>
        </div>
    </div>

    <!-- Kick Selection Dialog -->
    <div class="snare-dialog-overlay" id="kickDialogOverlay">
        <div class="snare-dialog">
            <div class="snare-dialog-title">SELECT KICK TYPE</div>
            <div class="snare-options">
                <div class="snare-option selected" data-kick-type="bd-1">
                    KICK 1
                </div>
                <div class="snare-option" data-kick-type="bd-2">
                    KICK 2
                </div>
                <div class="snare-option" data-kick-type="bd-3">
                    KICK 3
                </div>
                <div class="snare-option" data-kick-type="bd-4">
                    KICK 4
                </div>
            </div>
            <button class="snare-dialog-close" id="kickDialogClose">CLOSE</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
    <script>
        // Drum Machine App
        class DrumMachine {
            constructor() {
                this.bpm = 100;
                this.currentStep = 0;
                this.isPlaying = false;
                this.sequence = null;
                this.kickType = 'bd-1'; // bd-1, bd-2, bd-3, bd-4
                this.snareType = 'rytm-classic'; // rytm-classic, rytm-hard, rytm-bright
                this.bassNote = 'E1'; // E1, F1, G1 - E1 is default (standard bass E string)
                
                // Default pattern from screenshot
                // Hi-hat pattern: 0 = off, 1 = closed, 2 = open
                // Bass pattern: null = off, 'E1', 'F1', 'G1' = note to play
                this.pattern = {
                    kick: [true, true, false, false,  true, true, false, false,  true, true, false, false,  false, false, false, true],
                    snare: [false, false, false, false,  true, false, false, false,  false, false, false, false,  true, false, false, false],
                    hihat: [1, 0, 1, 2,  1, 0, 1, 0,  1, 0, 1, 2,  1, 0, 1, 0],  // 0=off, 1=closed, 2=open
                    bass: ['E1', 'E1', null, null,  'E1', 'E1', null, null,  'E1', 'E1', null, null,  null, 'G1', 'F1', 'E1']
                };
                
                this.players = null;
                this.bassPlayer = null;
                this.audioReady = false;
                
                this.init();
            }

            async init() {
                await this.initAudio();
                this.setupEventListeners();
                this.loadInitialPattern();
            }

            loadInitialPattern() {
                // Set visual state for initial pattern
                Object.keys(this.pattern).forEach(sound => {
                    const row = document.querySelector(`.drum-row[data-sound="${sound}"]`);
                    
                    if (sound === 'hihat') {
                        // Handle three-state hi-hat
                        this.pattern[sound].forEach((state, stepIndex) => {
                            const stepElement = row.querySelector(`.step[data-step="${stepIndex}"]`);
                            if (state === 1) {
                                // Closed hi-hat
                                stepElement.classList.add('active');
                                stepElement.classList.remove('open');
                            } else if (state === 2) {
                                // Open hi-hat
                                stepElement.classList.add('active', 'open');
                            } else {
                                // Off
                                stepElement.classList.remove('active', 'open');
                            }
                        });
                    } else if (sound === 'bass') {
                        // Handle bass notes (null or 'E1', 'F1', 'G1')
                        this.pattern[sound].forEach((note, stepIndex) => {
                            const stepElement = row.querySelector(`.step[data-step="${stepIndex}"]`);
                            if (note) {
                                stepElement.classList.add('active');
                                // Show just the note letter (E, F, or G)
                                stepElement.textContent = note[0];
                            } else {
                                stepElement.classList.remove('active');
                                stepElement.textContent = '';
                            }
                        });
                    } else {
                        // Handle kick and snare (boolean)
                        this.pattern[sound].forEach((active, stepIndex) => {
                            if (active) {
                                const stepElement = row.querySelector(`.step[data-step="${stepIndex}"]`);
                                stepElement.classList.add('active');
                            }
                        });
                    }
                });
            }

            async initAudio() {
                try {
                    // Load Tidal Dirt-Samples from GitHub CDN
                    // Source: https://github.com/tidalcycles/Dirt-Samples
                    // Using ONLY confirmed working samples from Strudel documentation
                    const tidalBase = 'https://raw.githubusercontent.com/tidalcycles/Dirt-Samples/master/';
                    
                    // Create sampler with confirmed working samples
                    this.drumSampler = new Tone.Sampler({
                        urls: {
                            // Kicks - using bd folder samples
                            "C1": "bd/BT0AADA.wav",              // Kick 1
                            "C#1": "bd/BT0AAD0.wav",             // Kick 2
                            "D1": "bd/BT0A0DA.wav",              // Kick 3
                            "D#1": "bd/BT0A0D0.wav",             // Kick 4
                            
                            // Snares - using sd folder samples (rytm-01 and rytm-00 confirmed working)
                            "E1": "sd/rytm-01-classic.wav",      // Classic (confirmed)
                            "F1": "sd/rytm-00-hard.wav",         // Hard (confirmed)
                            "F#1": "sd/rytm-01-classic.wav",     // Bright (duplicate of classic for now)
                            
                            // Hi-hats - using hh27 folder
                            "G1": "hh27/000_hh27closedhh.wav",   // Closed (confirmed)
                            "G#1": "hh27/000_hh27closedhh.wav"   // Open (using closed as duplicate for now)
                        },
                        baseUrl: tidalBase,
                        onload: () => {
                            console.log("Tidal Dirt-Samples loaded successfully from GitHub CDN");
                            this.audioReady = true;
                            this.hideLoading();
                        },
                        onerror: (error) => {
                            console.error("Error loading Tidal samples:", error);
                            console.log("Falling back to synthesized drums");
                            this.createFallbackDrums();
                            this.audioReady = true;
                            this.hideLoading();
                        }
                    }).toDestination();
                    
                    // Load bass guitar samples from tonejs-instruments
                    // Source: https://github.com/nbrosowsky/tonejs-instruments (Karoryfer samples)
                    // Try loading E1 and G1 files directly
                    const bassBase = 'https://nbrosowsky.github.io/tonejs-instruments/samples/bass-electric/';
                    
                    this.bassPlayer = new Tone.Sampler({
                        urls: {
                            "E1": "E1.mp3",   // Try E1.mp3 file
                            "G1": "G1.mp3"    // Try G1.mp3 file
                        },
                        baseUrl: bassBase,
                        onload: () => {
                            console.log("Bass guitar samples loaded successfully");
                        },
                        onerror: (error) => {
                            console.error("Error loading bass samples:", error);
                            console.log("Trying fallback samples...");
                            // Fallback: try with detune
                            this.bassPlayer = new Tone.Sampler({
                                urls: {
                                    "E1": "E2.mp3",
                                    "G1": "G2.mp3"
                                },
                                baseUrl: bassBase
                            }).toDestination();
                            this.bassPlayer.detune.value = -1200;
                        }
                    }).toDestination();
                    
                } catch (error) {
                    console.error('Audio initialization error:', error);
                    this.createFallbackDrums();
                    this.audioReady = true;
                    this.hideLoading();
                }
            }

            createFallbackDrums() {
                // Fallback to better synthesis if MIDI samples fail
                this.kickSynth = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 10,
                    oscillator: { type: 'sine' },
                    envelope: {
                        attack: 0.001,
                        decay: 0.4,
                        sustain: 0.01,
                        release: 1.4
                    }
                }).toDestination();
                
                this.snareSynth = new Tone.NoiseSynth({
                    noise: { type: 'white' },
                    envelope: {
                        attack: 0.001,
                        decay: 0.2,
                        sustain: 0
                    }
                }).toDestination();
                
                this.hihatSynth = new Tone.MetalSynth({
                    frequency: 200,
                    envelope: {
                        attack: 0.001,
                        decay: 0.1,
                        release: 0.01
                    },
                    harmonicity: 5.1,
                    modulationIndex: 32,
                    resonance: 4000,
                    octaves: 1.5
                }).toDestination();
            }


            setupEventListeners() {
                // Step buttons - handle kick, snare (toggle), hihat (3-state)
                document.querySelectorAll('.step').forEach(step => {
                    step.addEventListener('click', (e) => this.toggleStep(e.target));
                });

                // Play button
                document.getElementById('playBtn').addEventListener('click', () => this.togglePlay());

                // Clear button
                document.getElementById('clearBtn').addEventListener('click', () => this.clearPattern());

                // Reset button
                document.getElementById('resetBtn').addEventListener('click', () => this.resetPattern());

                // BPM input
                document.getElementById('bpm').addEventListener('input', (e) => {
                    const newBpm = parseInt(e.target.value);
                    if (newBpm >= 40 && newBpm <= 240) {
                        this.bpm = newBpm;
                        if (this.isPlaying) {
                            Tone.Transport.bpm.rampTo(this.bpm, 0.1);
                        }
                    }
                });

                // BPM decrease button
                document.getElementById('bpmDown').addEventListener('click', () => {
                    const newBpm = Math.max(40, this.bpm - 1);
                    this.bpm = newBpm;
                    document.getElementById('bpm').value = newBpm;
                    if (this.isPlaying) {
                        Tone.Transport.bpm.rampTo(this.bpm, 0.1);
                    }
                });

                // BPM increase button
                document.getElementById('bpmUp').addEventListener('click', () => {
                    const newBpm = Math.min(240, this.bpm + 1);
                    this.bpm = newBpm;
                    document.getElementById('bpm').value = newBpm;
                    if (this.isPlaying) {
                        Tone.Transport.bpm.rampTo(this.bpm, 0.1);
                    }
                });

                // Kick label click - open dialog
                document.getElementById('kickLabel').addEventListener('click', () => {
                    this.openKickDialog();
                });

                // Kick dialog close button
                document.getElementById('kickDialogClose').addEventListener('click', () => {
                    this.closeKickDialog();
                });

                // Close kick dialog when clicking overlay
                document.getElementById('kickDialogOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'kickDialogOverlay') {
                        this.closeKickDialog();
                    }
                });

                // Kick option selection
                document.querySelectorAll('[data-kick-type]').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const kickType = e.target.dataset.kickType;
                        this.selectKickType(kickType);
                    });
                });

                // Snare label click - open dialog
                const snareLabel = document.getElementById('snareLabel');
                console.log('Snare label element:', snareLabel);
                if (snareLabel) {
                    snareLabel.addEventListener('click', () => {
                        console.log('Snare label clicked!');
                        this.openSnareDialog();
                    });
                } else {
                    console.error('Snare label not found!');
                }

                // Snare dialog close button
                document.getElementById('snareDialogClose').addEventListener('click', () => {
                    this.closeSnareDialog();
                });

                // Close dialog when clicking overlay
                document.getElementById('snareDialogOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'snareDialogOverlay') {
                        this.closeSnareDialog();
                    }
                });

                // Snare option selection
                document.querySelectorAll('[data-snare-type]').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const snareType = e.target.dataset.snareType;
                        this.selectSnareType(snareType);
                    });
                });

            }

            openKickDialog() {
                document.getElementById('kickDialogOverlay').classList.add('show');
            }

            closeKickDialog() {
                document.getElementById('kickDialogOverlay').classList.remove('show');
            }

            selectKickType(type) {
                this.kickType = type;
                
                // Update visual selection
                document.querySelectorAll('[data-kick-type]').forEach(option => {
                    if (option.dataset.kickType === type) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
                
                console.log('Kick type changed to:', this.kickType);
                
                // Auto-close dialog after selection
                setTimeout(() => {
                    this.closeKickDialog();
                }, 300);
            }

            openSnareDialog() {
                console.log('Opening snare dialog');
                document.getElementById('snareDialogOverlay').classList.add('show');
            }

            closeSnareDialog() {
                console.log('Closing snare dialog');
                document.getElementById('snareDialogOverlay').classList.remove('show');
            }

            selectSnareType(type) {
                this.snareType = type;
                
                // Update visual selection
                document.querySelectorAll('[data-snare-type]').forEach(option => {
                    if (option.dataset.snareType === type) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
                
                console.log('Snare type changed to:', this.snareType);
                
                // Auto-close dialog after selection
                setTimeout(() => {
                    this.closeSnareDialog();
                }, 300);
            }


            toggleStep(stepElement) {
                const row = stepElement.closest('.drum-row');
                const sound = row.dataset.sound;
                const stepIndex = parseInt(stepElement.dataset.step);
                
                if (sound === 'hihat') {
                    // Three-state cycle: 0 (off) -> 1 (closed) -> 2 (open) -> 0 (off)
                    const currentState = this.pattern.hihat[stepIndex];
                    
                    if (currentState === 0) {
                        // Off -> Closed
                        this.pattern.hihat[stepIndex] = 1;
                        stepElement.classList.add('active');
                        stepElement.classList.remove('open');
                    } else if (currentState === 1) {
                        // Closed -> Open
                        this.pattern.hihat[stepIndex] = 2;
                        stepElement.classList.add('active', 'open');
                    } else {
                        // Open -> Off
                        this.pattern.hihat[stepIndex] = 0;
                        stepElement.classList.remove('active', 'open');
                    }
                } else if (sound === 'bass') {
                    // Bass: cycle through null -> E1 -> F1 -> G1 -> null
                    const currentNote = this.pattern.bass[stepIndex];
                    const noteSequence = [null, 'E1', 'F1', 'G1'];
                    const currentIndex = noteSequence.indexOf(currentNote);
                    const nextIndex = (currentIndex + 1) % noteSequence.length;
                    const nextNote = noteSequence[nextIndex];
                    
                    this.pattern.bass[stepIndex] = nextNote;
                    
                    // Update visual state
                    if (nextNote === null) {
                        stepElement.classList.remove('active');
                        stepElement.textContent = '';
                    } else {
                        stepElement.classList.add('active');
                        // Show just the note letter (E, F, or G)
                        stepElement.textContent = nextNote[0];
                    }
                } else {
                    // Kick and Snare: simple toggle
                    this.pattern[sound][stepIndex] = !this.pattern[sound][stepIndex];
                    stepElement.classList.toggle('active');
                }
            }

            async togglePlay() {
                if (!this.audioReady) {
                    console.warn("Audio not ready yet");
                    return;
                }

                if (!this.isPlaying) {
                    // Resume AudioContext on user interaction (required by browsers)
                    await Tone.start();
                    console.log("AudioContext started");
                    this.startPlayback();
                } else {
                    this.stopPlayback();
                }
            }

            startPlayback() {
                this.isPlaying = true;
                document.getElementById('playBtn').classList.add('playing');
                document.getElementById('playBtn').textContent = 'Stop';

                Tone.Transport.bpm.value = this.bpm;
                this.currentStep = 0;
                
                // Use scheduleRepeat for stable timing
                let stepCounter = 0;
                this.sequence = Tone.Transport.scheduleRepeat((time) => {
                    const step = stepCounter % 16;
                    
                    // Schedule visual updates using the provided time
                    Tone.Draw.schedule(() => {
                        this.updateVisualStep(step);
                    }, time);

                    // Play kick with selected type
                    if (this.pattern.kick[step]) {
                        this.playKick(time);
                        Tone.Draw.schedule(() => {
                            this.flashStep('kick', step);
                        }, time);
                    }
                    
                    // Play snare with selected type
                    if (this.pattern.snare[step]) {
                        this.playSnare(time);
                        Tone.Draw.schedule(() => {
                            this.flashStep('snare', step);
                        }, time);
                    }
                    
                    // Hi-hat three states: 0=off, 1=closed, 2=open
                    const hihatState = this.pattern.hihat[step];
                    if (hihatState === 1) {
                        this.playHihat(false, time); // Closed
                        Tone.Draw.schedule(() => {
                            this.flashStep('hihat', step);
                        }, time);
                    } else if (hihatState === 2) {
                        this.playHihat(true, time); // Open
                        Tone.Draw.schedule(() => {
                            this.flashStep('hihat', step);
                        }, time);
                    }
                    
                    // Play bass with note from pattern (E1, F1, G1, or null)
                    const bassNote = this.pattern.bass[step];
                    if (bassNote) {
                        this.playBass(time, bassNote);
                        Tone.Draw.schedule(() => {
                            this.flashStep('bass', step);
                        }, time);
                    }
                    
                    stepCounter++;
                }, '16n', 0);

                Tone.Transport.start();
            }

            playKick(time) {
                // Map kick type to note
                const kickNotes = {
                    'bd-1': 'C1',
                    'bd-2': 'C#1',
                    'bd-3': 'D1',
                    'bd-4': 'D#1'
                };
                
                const note = kickNotes[this.kickType];
                if (this.drumSampler && note) {
                    this.drumSampler.triggerAttackRelease(note, '16n', time);
                }
            }

            playSnare(time) {
                // Map snare type to note
                const snareNotes = {
                    'rytm-classic': 'E1',
                    'rytm-hard': 'F1',
                    'rytm-bright': 'F#1'
                };
                
                const note = snareNotes[this.snareType];
                if (this.drumSampler && note) {
                    this.drumSampler.triggerAttackRelease(note, '16n', time);
                }
            }

            playHihat(isOpen, time) {
                // Closed = G1, Open = G#1
                const note = isOpen ? 'G#1' : 'G1';
                const duration = isOpen ? '16n' : '32n';
                
                if (this.drumSampler && note) {
                    this.drumSampler.triggerAttackRelease(note, duration, time);
                }
            }

            playBass(time, note) {
                // Play the specified bass note (E1, F1, or G1)
                if (this.bassPlayer && note) {
                    this.bassPlayer.triggerAttackRelease(note, '16n', time);
                }
            }

            stopPlayback() {
                this.isPlaying = false;
                document.getElementById('playBtn').classList.remove('playing');
                document.getElementById('playBtn').textContent = 'Play';

                // Clear the scheduled repeat event
                if (this.sequence !== null) {
                    Tone.Transport.clear(this.sequence);
                    this.sequence = null;
                }
                
                // Stop transport and reset position
                Tone.Transport.stop();
                Tone.Transport.cancel(0); // Cancel all scheduled events
                Tone.Transport.position = 0;
                
                // Clear visual state
                this.clearVisualSteps();
                this.currentStep = 0;
            }

            updateVisualStep(step) {
                // Remove current-beat from all steps
                document.querySelectorAll('.step').forEach(s => {
                    s.classList.remove('current-beat');
                });

                // Add current-beat to current step in all rows
                document.querySelectorAll(`.step[data-step="${step}"]`).forEach(s => {
                    s.classList.add('current-beat');
                });
            }

            flashStep(sound, step) {
                const row = document.querySelector(`.drum-row[data-sound="${sound}"]`);
                const stepElement = row.querySelector(`.step[data-step="${step}"]`);
                
                stepElement.classList.add('playing');
                setTimeout(() => {
                    stepElement.classList.remove('playing');
                }, 100);
            }

            clearVisualSteps() {
                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('current-beat', 'playing');
                });
            }

            clearPattern() {
                this.pattern = {
                    kick: new Array(16).fill(false),
                    snare: new Array(16).fill(false),
                    hihat: new Array(16).fill(0),  // 0=off, 1=closed, 2=open
                    bass: new Array(16).fill(null)  // null for no note
                };

                document.querySelectorAll('.step').forEach(step => {
                    step.classList.remove('active', 'open');
                    step.textContent = '';  // Clear any note letters
                });
            }

            resetPattern() {
                // Reset to original default pattern
                this.pattern = {
                    kick: [true, true, false, false,  true, true, false, false,  true, true, false, false,  false, false, false, true],
                    snare: [false, false, false, false,  true, false, false, false,  false, false, false, false,  true, false, false, false],
                    hihat: [1, 0, 1, 2,  1, 0, 1, 0,  1, 0, 1, 2,  1, 0, 1, 0],  // 0=off, 1=closed, 2=open
                    bass: ['E1', 'E1', null, null,  'E1', 'E1', null, null,  'E1', 'E1', null, null,  null, 'G1', 'F1', 'E1']
                };

                // Update visual state for all rows
                Object.keys(this.pattern).forEach(sound => {
                    const row = document.querySelector(`.drum-row[data-sound="${sound}"]`);
                    
                    if (sound === 'hihat') {
                        // Handle three-state hi-hat
                        this.pattern[sound].forEach((state, stepIndex) => {
                            const stepElement = row.querySelector(`.step[data-step="${stepIndex}"]`);
                            if (state === 1) {
                                // Closed hi-hat
                                stepElement.classList.add('active');
                                stepElement.classList.remove('open');
                            } else if (state === 2) {
                                // Open hi-hat
                                stepElement.classList.add('active', 'open');
                            } else {
                                // Off
                                stepElement.classList.remove('active', 'open');
                            }
                        });
                    } else if (sound === 'bass') {
                        // Handle bass notes
                        this.pattern[sound].forEach((note, stepIndex) => {
                            const stepElement = row.querySelector(`.step[data-step="${stepIndex}"]`);
                            if (note) {
                                stepElement.classList.add('active');
                                stepElement.textContent = note[0];  // Show note letter
                            } else {
                                stepElement.classList.remove('active');
                                stepElement.textContent = '';
                            }
                        });
                    } else {
                        // Handle kick and snare (boolean)
                        this.pattern[sound].forEach((active, stepIndex) => {
                            const stepElement = row.querySelector(`.step[data-step="${stepIndex}"]`);
                            if (active) {
                                stepElement.classList.add('active');
                            } else {
                                stepElement.classList.remove('active');
                            }
                        });
                    }
                });
            }

            hideLoading() {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Initialize app
        const drumMachine = new DrumMachine();
    </script>
</body>
</html>
